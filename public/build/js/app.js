let paso=1;const pasoInicial=1,pasoFinal=4,cita={id:"",nombre:"",fecha:"",hora:"",servicios:[]};function cargarDatosGuardados(){const e=localStorage.getItem("cita"),t=localStorage.getItem("paso");if(e){const t=JSON.parse(e);Object.assign(cita,t)}t&&(paso=parseInt(t),mostrarSeccion(),mostrarResumen())}function iniciarApp(){mostrarSeccion(),tabs(),botonesPaginador(),paginaSiguiente(),paginaAnterior(),consultarAPI(),idCliente(),nombreCliente(),seleccionarFecha(),seleccionarHora()}async function consultarAPI(){try{const e="/api/servicios",t=await fetch(e),o=await t.json();o.error?(console.error(o.error),mostrarAlerta("Error al cargar los servicios","error")):mostrarServicios(o)}catch(e){console.error(e),mostrarAlerta("Error al cargar los servicios","error")}}function mostrarServicios(e){const t=document.querySelector("#servicios");t?(t.innerHTML="",e.forEach(e=>{const{id:o,nombre_servicio:a,precio:r,tiempo_estimado:n}=e,c=parseInt(r).toLocaleString("es-CL"),s=formatearTiempo(parseInt(n)),i=document.createElement("DIV");i.classList.add("servicio"),i.dataset.idServicio=o;cita.servicios.some(e=>e.id===o)&&i.classList.add("seleccionado"),i.innerHTML=`\n            <p class="nombre-servicio">${a}</p>\n            <p class="precio-servicio">$${c}</p>\n            <p class="tiempo-servicio text-sm text-gray-600">Duración: ${s}</p>\n        `,i.onclick=()=>seleccionarServicio(e),t.appendChild(i)})):console.error("El contenedor de servicios no existe")}function paginaSiguiente(){const e=document.querySelector("#siguiente");e&&e.addEventListener("click",()=>{paso>=4||(1!==paso||validarServicios())&&(2!==paso||validarFecha())&&(paso++,mostrarSeccion(),botonesPaginador(),mostrarResumen())})}function paginaAnterior(){const e=document.querySelector("#anterior");e&&e.addEventListener("click",()=>{paso<=1||(paso--,mostrarSeccion(),botonesPaginador())})}function botonesPaginador(){const e=document.querySelector("#anterior"),t=document.querySelector("#siguiente");e&&t&&(1===paso?e.classList.add("hidden"):(e.classList.remove("hidden"),e.classList.remove("opacity-50"),e.disabled=!1),4===paso?t.classList.add("hidden"):(t.classList.remove("hidden"),t.classList.remove("opacity-50"),t.disabled=!1,t.textContent="Siguiente »"))}function mostrarSeccion(){const e=document.querySelector(".seccion:not(.hidden)");e&&e.classList.add("hidden");const t="#paso-"+paso,o=document.querySelector(t);o&&o.classList.remove("hidden");const a=document.querySelector(".step-button.bg-blue-500");a&&(a.classList.remove("bg-blue-500","text-white"),a.classList.add("bg-gray-300","text-gray-600"));const r=document.querySelector(`[data-paso="${paso}"]`);r&&(r.classList.remove("bg-gray-300","text-gray-600"),r.classList.add("bg-blue-500","text-white"));const n=document.querySelector("#progress");n&&(n.style.width=paso/4*100+"%"),localStorage.setItem("paso",paso)}function mostrarAlerta(e,t){if("undefined"==typeof Swal)return console.error("SweetAlert2 no está cargado"),void alert(e);Swal.fire({icon:t,title:"error"===t?"Error":"Éxito",text:e})}function tabs(){document.querySelectorAll(".step-button").forEach(e=>{e.addEventListener("click",(function(e){const t=parseInt(e.target.dataset.paso);if(t<paso)return paso=t,mostrarSeccion(),void botonesPaginador();(1!==paso||validarServicios())&&(2!==paso||validarFecha())&&(t-paso==1?(paso=t,mostrarSeccion(),botonesPaginador()):mostrarAlerta("Por favor, complete los pasos en orden","error"))}))})}function actualizarBotonConfirmar(){const e=document.querySelector('input[name="payment-method"]:checked'),t=document.getElementById("confirmar-pago");t.disabled=!e,document.querySelectorAll(".payment-option").forEach(e=>{const t=e.querySelector(".payment-check");e.querySelector("input").checked?(t.classList.add("opacity-100"),e.querySelector("label").classList.add("border-blue-500")):(t.classList.remove("opacity-100"),e.querySelector("label").classList.remove("border-blue-500"))}),t.onclick=async()=>{t.disabled=!0,t.textContent="Procesando...",document.querySelectorAll('input[name="payment-method"]').forEach(e=>{e.disabled=!0});const e=document.querySelector('input[name="payment-method"]:checked').value;if("local"===e)try{if((await Swal.fire({title:"¿Confirmar cita?",html:'\n                        <p class="mb-4">Has seleccionado pago en establecimiento.</p>\n                        <p class="text-sm text-gray-600">\n                            Recuerda que deberás realizar el pago al momento de llegar a tu cita.\n                        </p>\n                    ',icon:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Sí, confirmar cita",cancelButtonText:"Cancelar",allowOutsideClick:!1,allowEscapeKey:!1})).isConfirmed){const t=new FormData;t.append("fecha",cita.fecha),t.append("hora",cita.hora),t.append("usuarioId",cita.id),t.append("servicios",cita.servicios.map(e=>e.id)),t.append("pago",e),t.append("estado","pendiente");const o="/api/citas",a=await fetch(o,{method:"POST",body:t});(await a.json()).resultado&&(localStorage.removeItem("cita"),localStorage.removeItem("paso"),Swal.fire({icon:"success",title:"¡Cita Confirmada!",text:"Tu cita ha sido agendada correctamente",confirmButtonText:"OK",allowOutsideClick:!1,allowEscapeKey:!1}).then(()=>{window.location.href="/"}))}else t.disabled=!1,t.textContent="Confirmar Cita",document.querySelectorAll('input[name="payment-method"]').forEach(e=>{e.disabled=!1})}catch(e){console.error(e),Swal.fire({icon:"error",title:"Error",text:"Hubo un error al guardar la cita",confirmButtonText:"OK",allowOutsideClick:!1,allowEscapeKey:!1}).then(()=>{t.disabled=!1,t.textContent="Confirmar Cita",document.querySelectorAll('input[name="payment-method"]').forEach(e=>{e.disabled=!1})})}else"paypal"===e&&document.querySelector("#paypal-button-container").classList.remove("hidden")}}function validarServicios(){return 0!==cita.servicios.length||(mostrarAlerta("Debes seleccionar al menos un servicio","error"),!1)}function validarFecha(){return!(""===document.querySelector("#fecha").value||!cita.hora)||(mostrarAlerta("Debes seleccionar fecha y hora","error"),!1)}function validarResumen(){return!Object.values(cita).includes("")||(mostrarAlerta("Faltan datos por confirmar","error"),!1)}function seleccionarServicio(e){const{id:t}=e,{servicios:o}=cita,a=document.querySelector(`[data-id-servicio="${t}"]`);o.some(e=>e.id===t)?(cita.servicios=o.filter(e=>e.id!==t),a.classList.remove("seleccionado")):(cita.servicios=[...o,e],a.classList.add("seleccionado")),localStorage.setItem("cita",JSON.stringify(cita)),mostrarResumen()}function idCliente(){const e=document.querySelector("#id");e&&(cita.id=e.value)}function nombreCliente(){const e=document.querySelector("#nombre");e&&(cita.nombre=e.value)}function seleccionarFecha(){const e=document.querySelector("#fecha"),t=document.querySelector("#horas-disponibles");if(!e||!t)return;const o=new Date,a=o.getFullYear(),r=(o.getMonth()+1).toString().padStart(2,"0"),n=o.getDate().toString().padStart(2,"0"),c=`${a}-${r}-${n}`;e.min=c,cita.fecha&&(e.value=cita.fecha,mostrarHorasDisponibles()),e.addEventListener("input",(function(e){const[o,c,s]=e.target.value.split("-"),i=new Date(o,c-1,s);if(i<new Date(a,r-1,n))e.target.value="",mostrarAlerta("No puedes seleccionar fechas pasadas","error"),t.classList.add("hidden"),cita.fecha="",cita.hora="";else{const o=i.getDay();[6,0].includes(o)?(e.target.value="",mostrarAlerta("Fines de semana no permitidos","error"),t.classList.add("hidden"),cita.fecha="",cita.hora=""):(cita.fecha=e.target.value,mostrarHorasDisponibles())}mostrarResumen(),localStorage.setItem("cita",JSON.stringify(cita))}))}function mostrarHorasDisponibles(){const e=document.querySelector("#horas-disponibles");if(!e)return void console.error("No se encontró el contenedor de horas disponibles");e.classList.remove("hidden");const t={"mañana":["10:00","10:50","11:40"],tarde:["12:30","15:00","15:50","16:40","17:30"],noche:["18:20","19:10"]};["mañana","tarde","noche"].forEach(e=>{const o=document.querySelector("#horas-"+e);o?(o.innerHTML="",t[e].forEach(e=>{const t=document.createElement("BUTTON");t.type="button",t.classList.add("px-4","py-2","text-sm","border","rounded","hover:bg-blue-500","hover:text-white"),cita.hora===e&&t.classList.add("bg-blue-500","text-white"),t.textContent=e,t.onclick=function(){document.querySelectorAll('button[type="button"]').forEach(e=>{e.classList.remove("bg-blue-500","text-white")}),this.classList.add("bg-blue-500","text-white"),cita.hora=e,localStorage.setItem("cita",JSON.stringify(cita)),mostrarResumen()},o.appendChild(t)})):console.error("No se encontró el contenedor para "+e)})}function seleccionarHora(){document.querySelector("#hora").addEventListener("input",(function(e){const t=e.target.value.split(":")[0];t<10||t>18?(e.target.value="",mostrarAlerta("Hora no válida","error")):cita.hora=e.target.value}))}function formatearTiempo(e){const t=Math.floor(e/60),o=e%60;let a="";return t>0&&(a+=`${t} ${1===t?"hora":"horas"}`),o>0&&(t>0&&(a+=" y "),a+=`${o} ${1===o?"minuto":"minutos"}`),a||"0 minutos"}function mostrarResumen(){const e=document.querySelector("#resumen-cita");if(!e)return;for(;e.firstChild;)e.removeChild(e.firstChild);if(Object.values(cita).includes("")||0===cita.servicios.length){const t=document.createElement("P");return t.classList.add("text-center","text-gray-600","mt-5"),t.textContent="Faltan datos por completar",void e.appendChild(t)}const{nombre:t,fecha:o,hora:a,servicios:r}=cita,n=document.createElement("DIV");n.classList.add("p-6","space-y-6");const c=document.createElement("P");c.innerHTML='<span class="font-bold">Nombre:</span> '+t,c.classList.add("text-lg");const s=document.createElement("DIV");s.classList.add("space-y-3");const i=document.createElement("H3");i.textContent="Servicios Seleccionados:",i.classList.add("font-bold","text-lg","mb-3"),s.appendChild(i);let l=0,d=0;r.forEach(e=>{const{nombre_servicio:t,precio:o,tiempo_estimado:a}=e,r=document.createElement("P");l+=parseInt(a),d+=parseFloat(o);const n=new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP"}).format(o),c=formatearTiempo(parseInt(a));r.textContent=`${t} - ${n} (${c})`,s.appendChild(r)});const u=document.createElement("P"),m=formatearTiempo(l);u.innerHTML='<span class="font-bold">Tiempo Total Estimado:</span> '+m,u.classList.add("bg-blue-50","rounded-lg","text-lg","mt-4");const[p,h,f]=o.split("-"),g=new Date(p,h-1,f).toLocaleDateString("es-CL",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),y=g.charAt(0).toUpperCase()+g.slice(1),b=document.createElement("P");b.innerHTML='<span class="font-bold">Fecha:</span> '+y,b.classList.add("text-lg");const v=document.createElement("P");v.innerHTML=`<span class="font-bold">Hora:</span> ${a} hrs`,v.classList.add("text-lg");const S=new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP"}).format(d),L=document.createElement("P");if(L.innerHTML='<span class="font-bold">Total a Pagar:</span> '+S,L.classList.add("bg-gray-100","p-4","rounded-lg","text-lg","mt-6","text-center"),n.appendChild(c),n.appendChild(s),n.appendChild(u),n.appendChild(b),n.appendChild(v),n.appendChild(L),e.appendChild(n),3===paso){const e=document.querySelector("#siguiente");e&&(e.classList.remove("opacity-50"),e.disabled=!1)}}document.addEventListener("DOMContentLoaded",(function(){cargarDatosGuardados(),iniciarApp()}));
//# sourceMappingURL=app.js.map
